<?php
require_once '../config/config.php';

if (!isLoggedIn()) {
    redirect('login.php');
}

$page_title = 'Dashboard';
require_once 'includes/header.php';

// Get statistics
$jobs = getJsonData(JOBS_DB)['jobs'] ?? [];
$companies = getJsonData(COMPANIES_DB)['companies'] ?? [];
$users = getJsonData(USERS_DB)['users'] ?? [];

$activeJobs = array_filter($jobs, function($job) {
    return $job['status'] === 'active' && strtotime($job['expiry_date']) > time();
});

$recentJobs = array_slice($jobs, -5);
?>

<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Jobs</h6>
                            <h3 class="mb-0"><?php echo count($jobs); ?></h3>
                        </div>
                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-briefcase text-white"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="text-success">
                            <i class="fas fa-arrow-up"></i> <?php echo count($activeJobs); ?> active
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Companies</h6>
                            <h3 class="mb-0"><?php echo count($companies); ?></h3>
                        </div>
                        <div class="rounded-circle bg-success d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-building text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Total Users</h6>
                            <h3 class="mb-0"><?php echo count($users); ?></h3>
                        </div>
                        <div class="rounded-circle bg-warning d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-users text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">Applications</h6>
                            <h3 class="mb-0">0</h3>
                        </div>
                        <div class="rounded-circle bg-danger d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Jobs -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Job Posts</h5>
                    <a href="jobs.php" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Job Title</th>
                                    <th>Company</th>
                                    <th>Type</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Posted Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach (array_reverse($recentJobs) as $job): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($job['title']); ?></td>
                                    <td><?php echo htmlspecialchars($job['company']); ?></td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            <?php echo ucfirst($job['job_type']); ?>
                                        </span>
                                    </td>
                                    <td><?php echo htmlspecialchars($job['location']); ?></td>
                                    <td>
                                        <?php
                                        $status = $job['status'];
                                        $badgeClass = '';
                                        if ($status === 'active') $badgeClass = 'badge-active';
                                        elseif ($status === 'pending') $badgeClass = 'badge-pending';
                                        elseif ($status === 'expired') $badgeClass = 'badge-expired';
                                        ?>
                                        <span class="badge <?php echo $badgeClass; ?>">
                                            <?php echo ucfirst($status); ?>
                                        </span>
                                    </td>
                                    <td><?php echo date('M d, Y', strtotime($job['posted_date'])); ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Jobs Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="jobsChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Jobs Chart
const ctx = document.getElementById('jobsChart').getContext('2d');
const jobsChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
            label: 'Jobs Posted',
            data: [12, 19, 15, 25, 22, 30, 28, 32, 35, 40, 38, 42],
            borderColor: '#4361ee',
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

<?php require_once 'includes/footer.php'; ?>
